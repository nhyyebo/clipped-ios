name: ğŸš€ iOS Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-ios:
    name: ğŸ“± Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¨ Generate code (Hive adapters)
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ§ª Run tests
        run: flutter test
        continue-on-error: true

      - name: ğŸ“‹ Flutter doctor
        run: flutter doctor -v

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ” Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}

      - name: ğŸ“± Import Provisioning Profile
        uses: Apple-Actions/download-provisioning-profiles@v1
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          bundle-id: 'com.nhyyebo.clipped'
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

      - name: ğŸ—ï¸ Build iOS (Development)
        if: github.event_name == 'workflow_dispatch'
        run: |
          flutter build ios --no-codesign --simulator
          
      - name: ğŸ—ï¸ Build iOS IPA (Release)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist

      - name: ğŸ“¤ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          name: clipped-ios-${{ github.ref_name }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: ğŸ‰ Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/ios/ipa/*.ipa
          name: Clipped iOS ${{ github.ref_name }}
          body: |
            ## ğŸ¨ Clipped - Beautiful iOS Clipboard Manager
            
            ### âœ¨ Features
            - ğŸ“‹ **Auto clipboard monitoring** - Detects new copied content
            - ğŸ¯ **One-tap copying** - Instant clipboard access
            - ğŸ” **Smart search** - Find your clips quickly
            - â­ **Favorites system** - Star important items
            - ğŸ·ï¸ **Categories** - Organize your content
            - ğŸ¨ **Beautiful dark UI** - Sleek iOS design
            
            ### ğŸ“± Installation
            1. Download the IPA file below
            2. Install using Xcode, AltStore, or your preferred method
            3. Trust the developer certificate in Settings
            
            ### ğŸ› Bug Reports
            Found an issue? Please [create an issue](https://github.com/nhyyebo/clipped-ios/issues)
            
            ---
            Built with â¤ï¸ using Flutter
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Upload to App Store Connect
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: Apple-Actions/upload-testflight-build@v1
        with:
          app-path: build/ios/ipa/*.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}